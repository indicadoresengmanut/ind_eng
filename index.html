<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Power BI Dashboards - TV</title>
    <style>
        /* Reset simplificado para compatibilidade */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: Arial, sans-serif;
            background: #000;
            overflow: hidden;
            height: 100vh;
            width: 100vw;
            -webkit-text-size-adjust: none;
            text-size-adjust: none;
        }
        
        .dashboard-container {
            position: relative;
            width: 100vw;
            height: 100vh;
            overflow: hidden;
        }
        
        .dashboard {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border: none;
            display: none;
            background: #000;
        }
        
        .dashboard.active {
            display: block;
        }
        
        .loader {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            color: #fff;
            z-index: 100;
            background: #000;
            padding: 20px;
            border-radius: 5px;
            border: 1px solid #333;
        }
        
        .dashboard-info {
            position: absolute;
            bottom: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.8);
            padding: 5px 10px;
            border-radius: 3px;
            font-size: 14px;
            color: #fff;
            z-index: 100;
        }
        
        .error-message {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            color: #ff6b6b;
            background: #000;
            padding: 20px;
            border-radius: 5px;
            border: 1px solid #333;
            display: none;
            max-width: 80%;
        }
        
        .tv-optimization {
            display: none;
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <div class="loader" id="loader">
            <p>Carregando...</p>
        </div>
        
        <div class="error-message" id="error-message">
            Erro ao carregar. Tentando novamente...
        </div>
        
        <div id="dashboards">
            <!-- Os iframes serão inseridos aqui via JavaScript -->
        </div>
        
        <div class="dashboard-info" id="dashboard-info"></div>
    </div>

    <!-- Elementos ocultos para otimização de TV -->
    <div class="tv-optimization">
        <!-- Pré-carregar recursos comuns -->
        <link rel="preconnect" href="https://app.powerbi.com">
        <link rel="dns-prefetch" href="https://app.powerbi.com">
    </div>

    <script>
        // Configuração otimizada para TV antiga
        const config = {
            dashboardUrls: [
                "https://app.powerbi.com/view?r=eyJrIjoiNjIyZjNiM2EtY2EwNi00YjY1LWI4Y2YtMTRkZDUwNmU4MTJmIiwidCI6ImE2NjFhZDU2LTQ4YzctNGFmNC04MGY2LTE0YzViMGNmOTk0ZCJ9&pageName=ReportSectionf046defa3f50ba229893",
                "https://app.powerbi.com/view?r=eyJrIjoiOTA1M2ZiYzItNWQ0NS00OTgxLWJmZTMtMWFhNDQ3MWZlNjg2IiwidCI6ImE2NjFhZDU2LTQ4YzctNGFmNC04MGY2LTE0YzViMGNmOTk0ZCJ9&pageName=ReportSection4a34beef4580782bdc68",
                "https://app.powerbi.com/view?r=eyJrIjoiODYyNTZmMWMtMzM4OC00NmQ4LWFhYTItYjNmOTZhNzdlNmMwIiwidCI6ImE2NjFhZDU2LTQ4YzctNGFmNC04MGY2LTE0YzViMGNmOTk0ZCJ9&pageName=ReportSection1a9e3c76c5d71bfd6425",
                "https://app.powerbi.com/view?r=eyJrIjoiODYyNTZmMWMtMzM4OC00NmQ4LWFhYTItYjNmOTZhNzdlNmMwIiwidCI6ImE2NjFhZDU2LTQ4YzctNGFmNC04MGY2LTE0YzViMGNmOTk0ZCJ9&pageName=ReportSection3c30acace2c6c0801cc0",
                "https://app.powerbi.com/view?r=eyJrIjoiODYyNTZmMWMtMzM4OC00NmQ4LWFhYTItYjNmOTZhNzdlNmMwIiwidCI6ImE2NjFhZDU2LTQ4YzctNGFmNC04MGY2LTE0YzViMGNmOTk0ZCJ9&pageName=ReportSection3238d0337d0447d9ed33"
            ],
            dashboardNames: [
                "Indicadores Engenharia",
                "Acompanhamento 2025",
                "Acomp. Inspeções",
                "Controle de Rec's",
                "Priorização de Rec's"
            ],
            rotationInterval: 60000,    // 60 segundos
            loadingTimeout: 45000,      // 45 segundos
            retryAttempts: 3,
            preloadNext: false,         // Desativado para TV antiga
            tvMode: true                // Modo TV ativado
        };
        
        // Variáveis de estado simplificadas
        let currentIndex = 0;
        let rotationInterval;
        let retryCount = 0;
        let isSwitching = false;
        let dashboardLoadedState = {};
        
        // Detectar capacidades da TV
        function detectTVCapabilities() {
            const capabilities = {
                hasWebGL: !!window.WebGLRenderingContext,
                hasCanvas: !!window.HTMLCanvasElement,
                hasFlexbox: 'flex' in document.documentElement.style,
                hasTransform: 'transform' in document.documentElement.style,
                userAgent: navigator.userAgent
            };
            
            console.log('Capacidades da TV:', capabilities);
            return capabilities;
        }
        
        // Inicializar a rotação
        function initRotation() {
            console.log("Iniciando rotação para TV");
            
            const tvCapabilities = detectTVCapabilities();
            
            if (!config.dashboardUrls || config.dashboardUrls.length === 0) {
                showError("Nenhum dashboard configurado.");
                return;
            }
            
            // Inicializar estado de carregamento
            config.dashboardUrls.forEach((_, index) => {
                dashboardLoadedState[index] = false;
            });
            
            // Mostrar loader
            document.getElementById('loader').style.display = 'block';
            
            // Carregar primeiro dashboard
            loadDashboard(currentIndex);
            
            // Iniciar rotação mais tarde
            setTimeout(startRotation, 5000);
        }
        
        // Carregar um dashboard específico
        function loadDashboard(index) {
            if (isSwitching) return;
            isSwitching = true;
            
            console.log(`Carregando dashboard ${index}`);
            
            const dashboardsContainer = document.getElementById('dashboards');
            
            // Verificar se já existe
            const existingIframe = document.getElementById(`dashboard-${index}`);
            if (existingIframe && dashboardLoadedState[index]) {
                console.log(`Dashboard ${index} já carregado`);
                switchToDashboard(index);
                isSwitching = false;
                return;
            }
            
            // Mostrar loader
            document.getElementById('loader').style.display = 'block';
            document.getElementById('error-message').style.display = 'none';
            
            // Remover iframe existente
            if (existingIframe) {
                existingIframe.remove();
            }
            
            // Criar iframe otimizado para TV
            const iframe = document.createElement('iframe');
            iframe.id = `dashboard-${index}`;
            iframe.className = 'dashboard';
            iframe.src = config.dashboardUrls[index];
            iframe.setAttribute('allowfullscreen', 'true');
            
            // Otimizações específicas para TV
            iframe.setAttribute('scrolling', 'no');
            iframe.style.visibility = 'hidden';
            
            // Evento de load otimizado
            const loadHandler = function() {
                console.log(`Dashboard ${index} carregado`);
                iframe.style.visibility = 'visible';
                dashboardLoadedState[index] = true;
                
                // Delay para garantir renderização
                setTimeout(() => {
                    switchToDashboard(index);
                    isSwitching = false;
                    
                    // Forçar redesenho para TV
                    forceRepaint();
                }, 2000);
            };
            
            iframe.addEventListener('load', loadHandler);
            
            // Evento de error
            iframe.addEventListener('error', () => {
                console.error(`Erro no dashboard ${index}`);
                
                if (retryCount < config.retryAttempts) {
                    retryCount++;
                    console.log(`Tentativa ${retryCount}`);
                    setTimeout(() => loadDashboard(index), 3000);
                } else {
                    retryCount = 0;
                    showError(`Erro no dashboard ${index+1}. Pulando...`);
                    setTimeout(() => {
                        document.getElementById('error-message').style.display = 'none';
                        nextDashboard();
                    }, 3000);
                }
            });
            
            // Timeout simplificado
            setTimeout(() => {
                if (!dashboardLoadedState[index] && document.getElementById(`dashboard-${index}`)) {
                    console.log(`Timeout dashboard ${index}`);
                    iframe.remove();
                    
                    if (retryCount < config.retryAttempts) {
                        retryCount++;
                        loadDashboard(index);
                    } else {
                        retryCount = 0;
                        nextDashboard();
                    }
                }
            }, config.loadingTimeout);
            
            // Adicionar iframe
            dashboardsContainer.appendChild(iframe);
        }
        
        // Forçar repaint para TV (solução para problemas de renderização)
        function forceRepaint() {
            const body = document.body;
            body.style.display = 'none';
            body.offsetHeight; // Trigger reflow
            body.style.display = 'block';
        }
        
        // Mostrar mensagem de erro
        function showError(message) {
            const errorElement = document.getElementById('error-message');
            errorElement.textContent = message;
            errorElement.style.display = 'block';
            document.getElementById('loader').style.display = 'none';
        }
        
        // Alternar para um dashboard específico
        function switchToDashboard(index) {
            console.log(`Alternando para dashboard ${index}`);
            
            // Esconder todos os dashboards
            const dashboards = document.querySelectorAll('.dashboard');
            for (let i = 0; i < dashboards.length; i++) {
                dashboards[i].classList.remove('active');
                dashboards[i].style.display = 'none';
            }
            
            // Mostrar o dashboard atual
            const currentDashboard = document.getElementById(`dashboard-${index}`);
            if (currentDashboard) {
                currentDashboard.classList.add('active');
                currentDashboard.style.display = 'block';
            }
            
            // Esconder loader
            document.getElementById('loader').style.display = 'none';
            document.getElementById('error-message').style.display = 'none';
            
            // Atualizar informações
            updateDashboardInfo(index);
            
            currentIndex = index;
            isSwitching = false;
        }
        
        // Atualizar informações do dashboard
        function updateDashboardInfo(index) {
            const infoElement = document.getElementById('dashboard-info');
            if (config.dashboardNames && config.dashboardNames[index]) {
                infoElement.textContent = `${config.dashboardNames[index]} | ${index + 1}/${config.dashboardUrls.length}`;
            } else {
                infoElement.textContent = `Dashboard ${index + 1}/${config.dashboardUrls.length}`;
            }
            
            // Esconder info após alguns segundos
            setTimeout(() => {
                infoElement.style.opacity = '0.5';
            }, 5000);
        }
        
        // Iniciar a rotação automática
        function startRotation() {
            clearInterval(rotationInterval);
            
            rotationInterval = setInterval(() => {
                if (!isSwitching) {
                    nextDashboard();
                }
            }, config.rotationInterval);
        }
        
        // Avançar para o próximo dashboard
        function nextDashboard() {
            const nextIndex = (currentIndex + 1) % config.dashboardUrls.length;
            console.log(`Próximo: ${nextIndex}`);
            
            if (dashboardLoadedState[nextIndex]) {
                switchToDashboard(nextIndex);
            } else {
                loadDashboard(nextIndex);
            }
        }
        
        // Limpar recursos periodicamente
        function cleanupMemory() {
            const currentTime = Date.now();
            const nextIndex = (currentIndex + 1) % config.dashboardUrls.length;
            
            document.querySelectorAll('.dashboard').forEach((dashboard) => {
                const id = dashboard.id;
                const dashboardIndex = parseInt(id.split('-')[1]);
                
                if (dashboardIndex !== currentIndex && dashboardIndex !== nextIndex) {
                    console.log(`Limpando dashboard ${dashboardIndex}`);
                    dashboard.remove();
                    dashboardLoadedState[dashboardIndex] = false;
                }
            });
        }
        
        // Tentar entrar em modo tela cheia
        function tryFullscreen() {
            const elem = document.documentElement;
            
            if (!document.fullscreenElement) {
                if (elem.requestFullscreen) {
                    elem.requestFullscreen().catch(err => {
                        console.log('Erro modo tela cheia: ', err);
                    });
                }
            }
        }
        
        // Inicialização segura para TV
        function safeInit() {
            try {
                console.log("Iniciando aplicação TV...");
                initRotation();
                
                // Limpar memória a cada 2 minutos
                setInterval(cleanupMemory, 120000);
                
                // Tentar tela cheia
                setTimeout(tryFullscreen, 1000);
                
            } catch (error) {
                console.error("Erro na inicialização:", error);
                showError("Erro na inicialização. Recarregando...");
                setTimeout(() => window.location.reload(), 5000);
            }
        }
        
        // Iniciar quando o documento estiver pronto
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', safeInit);
        } else {
            safeInit();
        }
        
        // Prevenir que a TV entre em modo de suspensão
        let activityTimer;
        function resetActivity() {
            clearTimeout(activityTimer);
            // Simular atividade a cada 30 segundos
            activityTimer = setTimeout(() => {
                const event = new Event('mousemove');
                document.dispatchEvent(event);
            }, 30000);
        }
        
        document.addEventListener('mousemove', resetActivity);
        document.addEventListener('keypress', resetActivity);
        resetActivity();
        
        console.log("Sistema TV carregado");
    </script>
</body>
</html>
